<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OEE Manufacturing System v30</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
        body {
            box-sizing: border-box;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .pulse-red {
            animation: pulse-red 2s infinite;
        }
        
        @keyframes pulse-red {
            0%, 100% { background-color: #fecaca; }
            50% { background-color: #ef4444; }
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        .loading {
            opacity: 0.5;
            pointer-events: none;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }
        
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
        }
        
        .metric-card.green {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .metric-card.orange {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .metric-card.purple {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .nav-btn {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .nav-btn::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: white;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        
        .nav-btn:hover::before,
        .nav-btn.active::before {
            transform: translateX(0);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(17, 153, 142, 0.3);
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(17, 153, 142, 0.4);
        }
        
        .input-field {
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        
        .input-field:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            outline: none;
        }
        
        .section-header {
            color: #1f2937;
            font-weight: 900;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.15);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fade-in {
            animation: fadeIn 0.6s ease forwards;
        }
        
        table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        table tbody tr {
            transition: all 0.2s ease;
        }
        
        table tbody tr:hover {
            background-color: #f3f4f6;
            transform: scale(1.01);
        }
        
        .toast {
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        .chart-card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }
        
        .chart-card:hover {
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }
        
        .filter-card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border-left: 4px solid #667eea;
        }
        
        .password-card {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(253, 203, 110, 0.3);
        }
        
        /* Responsive styles */
        @media (max-width: 768px) {
            .section-header {
                font-size: 1.75rem;
            }
            
            .chart-container {
                height: 250px;
            }
            
            .nav-btn {
                font-size: 0.875rem;
                padding: 0.75rem 0.5rem;
            }
            
            table {
                font-size: 0.75rem;
            }
            
            .metric-card {
                padding: 1rem;
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="min-h-full">
  <div id="app" class="min-h-full pb-8"><!-- Header -->
   <header class="glass-card mb-6 animate-fade-in" style="border-radius: 0;">
    <div class="max-w-7xl mx-auto px-4 md:px-6 py-6 md:py-8">
     <div class="flex items-center justify-between">
      <div>
       <h1 id="system-title" class="text-2xl md:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600">ğŸ­ OEE Manufacturing System</h1>
       <p id="company-name" class="text-gray-600 mt-2 text-sm md:text-lg">ğŸ“Š created by MSTD GOF</p>
      </div>
     </div>
    </div>
   </header><!-- Navigation -->
   <nav class="max-w-7xl mx-auto px-4 md:px-6 mb-8">
    <div class="glass-card rounded-2xl p-2">
     <div class="flex flex-wrap md:flex-nowrap space-x-1 md:space-x-2"><button onclick="showSection('dashboard')" class="nav-btn flex-1 py-3 md:py-4 px-2 md:px-6 rounded-xl text-purple-700 font-semibold hover:bg-purple-50 transition-all active" data-section="dashboard"> ğŸ“Š Dashboard </button> <button onclick="showSection('input')" class="nav-btn flex-1 py-3 md:py-4 px-2 md:px-6 rounded-xl text-purple-700 font-semibold hover:bg-purple-50 transition-all" data-section="input"> âœï¸ OEE Input </button> <button onclick="showSection('machines')" class="nav-btn flex-1 py-3 md:py-4 px-2 md:px-6 rounded-xl text-purple-700 font-semibold hover:bg-purple-50 transition-all" data-section="machines"> ğŸ”§ Machine </button> <button onclick="showSection('export')" class="nav-btn flex-1 py-3 md:py-4 px-2 md:px-6 rounded-xl text-purple-700 font-semibold hover:bg-purple-50 transition-all" data-section="export"> ğŸ“¥ Export </button>
     </div>
    </div>
   </nav><!-- Dashboard Section -->
   <section id="dashboard-section" class="section max-w-7xl mx-auto px-4 md:px-6">
    <div class="mb-6 animate-fade-in">
     <h2 class="section-header mb-6">ğŸ“ˆ Dashboard Analytics</h2><!-- Filters -->
     <div class="filter-card mb-8">
      <h3 class="text-lg font-semibold text-gray-700 mb-4">ğŸ” Filters</h3>
      <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
       <div><label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“… Start Date</label> <input type="date" id="filter-start-date" class="w-full input-field rounded-lg px-4 py-2">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“… End Date</label> <input type="date" id="filter-end-date" class="w-full input-field rounded-lg px-4 py-2">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">ğŸ­ Machine</label> <select id="filter-machine" class="w-full input-field rounded-lg px-4 py-2"> <option value="">All Machines</option> </select>
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">ğŸ‘¤ Operator (PIC)</label> <select id="filter-operator" class="w-full input-field rounded-lg px-4 py-2"> <option value="">All Operators</option> </select>
       </div>
       <div class="flex items-end"><button onclick="applyDashboardFilters()" class="w-full btn-primary text-white px-6 py-2 rounded-lg font-semibold"> Apply Filters </button>
       </div>
      </div>
     </div><!-- Key Metrics -->
     <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="metric-card">
       <div class="flex items-center justify-between mb-2">
        <h3 class="text-lg font-semibold opacity-90">Average OEE</h3><span class="text-3xl">ğŸ¯</span>
       </div>
       <p id="avg-oee" class="text-4xl font-bold">0%</p>
       <p class="text-sm opacity-80 mt-2">Overall Equipment Effectiveness</p>
      </div>
      <div class="metric-card green">
       <div class="flex items-center justify-between mb-2">
        <h3 class="text-lg font-semibold opacity-90">Total Output</h3><span class="text-3xl">ğŸ“¦</span>
       </div>
       <p id="total-output" class="text-4xl font-bold">0</p>
       <p class="text-sm opacity-80 mt-2">Production Units</p>
      </div>
      <div class="metric-card purple">
       <div class="flex items-center justify-between mb-2">
        <h3 class="text-lg font-semibold opacity-90">Active Machines</h3><span class="text-3xl">âš™ï¸</span>
       </div>
       <p id="active-machines" class="text-4xl font-bold">0</p>
       <p class="text-sm opacity-80 mt-2">Running Equipment</p>
      </div>
     </div><!-- Charts -->
     <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <div class="chart-card">
       <h3 class="text-lg font-semibold text-gray-700 mb-4">ğŸ“Š OEE Trend (Last 10 Records)</h3>
       <div class="chart-container">
        <canvas id="oee-trend-chart"></canvas>
       </div>
      </div>
      <div class="chart-card">
       <h3 class="text-lg font-semibold text-gray-700 mb-4">ğŸ­ OEE per Machine</h3>
       <div class="chart-container">
        <canvas id="oee-per-machine-chart"></canvas>
       </div>
      </div>
      <div class="chart-card">
       <h3 class="text-lg font-semibold text-gray-700 mb-4">ğŸ“ˆ A vs P vs Q Breakdown</h3>
       <div class="chart-container">
        <canvas id="apq-chart"></canvas>
       </div>
      </div>
      <div class="chart-card">
       <h3 class="text-lg font-semibold text-gray-700 mb-4">â±ï¸ ODT Analysis (Top 10)</h3>
       <div class="chart-container">
        <canvas id="odt-chart"></canvas>
       </div>
      </div>
      <div class="chart-card">
       <h3 class="text-lg font-semibold text-gray-700 mb-4">ğŸ”´ Line Stop Mesin (Top 10)</h3>
       <div class="chart-container">
        <canvas id="line-stop-mesin-chart"></canvas>
       </div>
      </div>
      <div class="chart-card">
       <h3 class="text-lg font-semibold text-gray-700 mb-4">ğŸŸ¡ Line Stop Non Mesin (Top 10)</h3>
       <div class="chart-container">
        <canvas id="line-stop-non-mesin-chart"></canvas>
       </div>
      </div>
      <div class="chart-card">
       <h3 class="text-lg font-semibold text-gray-700 mb-4">âš ï¸ Minor Stop Analysis (Top 10)</h3>
       <div class="chart-container">
        <canvas id="minor-stop-chart"></canvas>
       </div>
      </div>
     </div><!-- Operator Performance Table -->
     <div class="chart-card mb-8 overflow-x-auto">
      <h3 class="text-lg font-semibold text-gray-700 mb-4">ğŸ‘¥ Operator Performance</h3>
      <div class="overflow-x-auto">
       <table class="min-w-full table-auto">
        <thead>
         <tr>
          <th class="px-2 md:px-4 py-3 text-left text-xs md:text-sm font-medium">PIC</th>
          <th class="px-2 md:px-4 py-3 text-left text-xs md:text-sm font-medium">Avg OEE</th>
          <th class="px-2 md:px-4 py-3 text-left text-xs md:text-sm font-medium">Target Output</th>
          <th class="px-2 md:px-4 py-3 text-left text-xs md:text-sm font-medium">Actual Output</th>
          <th class="px-2 md:px-4 py-3 text-left text-xs md:text-sm font-medium">Achievement %</th>
          <th class="px-2 md:px-4 py-3 text-left text-xs md:text-sm font-medium">Records</th>
         </tr>
        </thead>
        <tbody id="operator-performance-table">
        </tbody>
       </table>
      </div>
     </div><!-- OEE History Table -->
     <div class="chart-card overflow-x-auto">
      <h3 class="text-lg font-semibold text-gray-700 mb-4">ğŸ“‹ OEE History</h3>
      <div class="overflow-x-auto">
       <table class="min-w-full table-auto">
        <thead>
         <tr>
          <th class="px-2 py-3 text-left text-xs font-medium">Date</th>
          <th class="px-2 py-3 text-left text-xs font-medium">Shift</th>
          <th class="px-2 py-3 text-left text-xs font-medium">Machine</th>
          <th class="px-2 py-3 text-left text-xs font-medium">PIC</th>
          <th class="px-2 py-3 text-left text-xs font-medium">Product</th>
          <th class="px-2 py-3 text-left text-xs font-medium">Batch</th>
          <th class="px-2 py-3 text-left text-xs font-medium">Output</th>
          <th class="px-2 py-3 text-left text-xs font-medium">Reject</th>
          <th class="px-2 py-3 text-left text-xs font-medium">A%</th>
          <th class="px-2 py-3 text-left text-xs font-medium">P%</th>
          <th class="px-2 py-3 text-left text-xs font-medium">Q%</th>
          <th class="px-2 py-3 text-left text-xs font-medium">OEE%</th>
          <th class="px-2 py-3 text-left text-xs font-medium">WR</th>
          <th class="px-2 py-3 text-left text-xs font-medium">ODT</th>
          <th class="px-2 py-3 text-left text-xs font-medium">Line Stop</th>
          <th class="px-2 py-3 text-left text-xs font-medium">Minor Stop</th>
         </tr>
        </thead>
        <tbody id="dashboard-history-table">
        </tbody>
       </table>
      </div>
     </div>
    </div>
   </section><!-- OEE Input Section -->
   <section id="input-section" class="section hidden max-w-4xl mx-auto px-4 md:px-6">
    <div class="glass-card rounded-2xl p-6 md:p-8 animate-fade-in">
     <h2 class="section-header mb-6">âœï¸ OEE Data Input</h2>
     <form id="oee-form" class="space-y-6"><!-- Basic Information -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
       <div><label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“… Date</label> <input type="date" id="input-date" required class="w-full input-field rounded-lg px-4 py-2">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">ğŸ• Shift</label> <select id="input-shift" required class="w-full input-field rounded-lg px-4 py-2" onchange="calculateTargetRecommendation()"> <option value="">Select Shift</option> <option value="shift1" data-minutes="510">Shift 1 (07:00 - 15:30)</option> <option value="shift2" data-minutes="450">Shift 2 (15:20 - 22:50)</option> <option value="shift3" data-minutes="510">Shift 3 (22:40 - 07:10)</option> <option value="longshift_pagi" data-minutes="720">Long Shift Pagi (07:00 - 19:00)</option> <option value="longshift_malam" data-minutes="720">Long Shift Malam (19:00 - 07:00)</option> </select>
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">ğŸ­ Machine</label> <select id="input-machine" required class="w-full input-field rounded-lg px-4 py-2" onchange="loadMachineTemplate()"> <option value="">Select Machine</option> </select>
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">ğŸ‘¤ PIC</label> <input type="text" id="input-pic" required class="w-full input-field rounded-lg px-4 py-2">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“¦ Product</label> <input type="text" id="input-product" required class="w-full input-field rounded-lg px-4 py-2">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">ğŸ·ï¸ Batch</label> <input type="text" id="input-batch" required class="w-full input-field rounded-lg px-4 py-2">
       </div>
      </div><!-- Dynamic Template Fields -->
      <div id="template-fields"></div><!-- Output Data -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
       <div><label class="block text-sm font-medium text-gray-700 mb-2">âœ… Actual Output</label> <input type="number" id="input-actual-output" required class="w-full input-field rounded-lg px-4 py-2" onchange="calculateOEE()">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">âŒ Reject</label> <input type="number" id="input-reject" required class="w-full input-field rounded-lg px-4 py-2" onchange="calculateOEE()">
       </div>
      </div><!-- Target Recommendation -->
      <div class="metric-card purple">
       <h3 class="text-lg font-semibold mb-2">ğŸ¯ Target Output Recommendation</h3>
       <p id="target-recommendation" class="text-white opacity-90">Select shift and machine to see recommendation</p>
      </div><!-- Calculated Results -->
      <div class="chart-card">
       <h3 class="text-lg font-semibold text-gray-700 mb-4">ğŸ“Š Calculated Results</h3>
       <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="text-center p-4 bg-red-50 rounded-lg"><label class="block text-sm font-medium text-gray-600 mb-2">Availability</label> <span id="calc-availability" class="text-2xl font-bold text-red-600">0%</span>
        </div>
        <div class="text-center p-4 bg-green-50 rounded-lg"><label class="block text-sm font-medium text-gray-600 mb-2">Performance</label> <span id="calc-performance" class="text-2xl font-bold text-green-600">0%</span>
        </div>
        <div class="text-center p-4 bg-purple-50 rounded-lg"><label class="block text-sm font-medium text-gray-600 mb-2">Quality</label> <span id="calc-quality" class="text-2xl font-bold text-purple-600">0%</span>
        </div>
        <div class="text-center p-4 bg-blue-50 rounded-lg"><label class="block text-sm font-medium text-gray-600 mb-2">OEE</label> <span id="calc-oee" class="text-2xl font-bold text-blue-600">0%</span>
        </div>
       </div>
      </div>
      <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4"><button type="button" id="submit-btn" onclick="submitOEEData()" class="btn-success text-white px-8 py-3 rounded-lg font-semibold"> ğŸ’¾ Simpan Data OEE </button> <button type="button" onclick="resetForm()" class="bg-gray-500 text-white px-8 py-3 rounded-lg font-semibold hover:bg-gray-600 transition-all"> ğŸ”„ Reset </button>
      </div>
     </form>
    </div>
   </section><!-- Machine Management Section -->
   <section id="machines-section" class="section hidden max-w-6xl mx-auto px-4 md:px-6">
    <div class="glass-card rounded-2xl p-6 md:p-8 animate-fade-in">
     <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 space-y-4 md:space-y-0">
      <h2 class="section-header">ğŸ”§ Machine Management</h2><button onclick="showMachineForm()" class="btn-success text-white px-6 py-3 rounded-lg font-semibold w-full md:w-auto"> â• Add Machine </button>
     </div><!-- Password Protection -->
     <div id="password-protection" class="mb-6">
      <div class="password-card"><label class="block text-sm font-medium text-gray-800 mb-2">ğŸ”’ Enter Admin Password</label>
       <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2"><input type="password" id="admin-password" placeholder="Enter password" class="flex-1 input-field rounded-lg px-4 py-2 bg-white"> <button onclick="checkPassword()" class="btn-primary text-white px-6 py-2 rounded-lg font-semibold"> ğŸ”“ Access </button>
       </div>
      </div>
     </div><!-- Machine Form -->
     <div id="machine-form-container" class="hidden mb-6">
      <form id="machine-form" class="space-y-6"><input type="hidden" id="edit-machine-id">
       <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div><label class="block text-sm font-medium text-gray-700 mb-2">ğŸ­ Machine Name</label> <input type="text" id="machine-name" required class="w-full input-field rounded-lg px-4 py-2">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“ Area</label> <select id="machine-area" required class="w-full input-field rounded-lg px-4 py-2"> <option value="">Select Area</option> <option value="INJEKSI">INJEKSI</option> <option value="NON INJEKSI">NON INJEKSI</option> </select>
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">ğŸ¯ Target per Minute</label> <input type="number" id="machine-target" required class="w-full input-field rounded-lg px-4 py-2">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">ğŸ‘¤ PIC</label> <input type="text" id="machine-pic" required class="w-full input-field rounded-lg px-4 py-2">
        </div>
       </div><!-- ODT Items -->
       <div class="chart-card"><label class="block text-sm font-medium text-gray-700 mb-4">â±ï¸ ODT Items</label>
        <div id="odt-items" class="space-y-2">
         <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2"><input type="text" placeholder="ODT Name" class="flex-1 input-field rounded-lg px-4 py-2 odt-name"> <input type="number" placeholder="Standard Time (min)" class="w-full md:w-32 input-field rounded-lg px-4 py-2 odt-time"> <button type="button" onclick="removeODTItem(this)" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-all">Remove</button>
         </div>
        </div><button type="button" onclick="addODTItem()" class="mt-3 btn-success text-white px-4 py-2 rounded-lg font-semibold"> â• Add ODT Item </button>
       </div><!-- Line Stop Categories -->
       <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="chart-card"><label class="block text-sm font-medium text-gray-700 mb-4">ğŸ”´ Line Stop Mesin</label>
         <div id="line-stop-mesin" class="space-y-2"><input type="text" placeholder="Line Stop Mesin Item" class="w-full input-field rounded-lg px-4 py-2 line-stop-mesin-item">
         </div><button type="button" onclick="addLineStopMesin()" class="mt-3 btn-success text-white px-4 py-2 rounded-lg font-semibold"> â• Add Item </button>
        </div>
        <div class="chart-card"><label class="block text-sm font-medium text-gray-700 mb-4">ğŸŸ¡ Line Stop Non Mesin</label>
         <div id="line-stop-non-mesin" class="space-y-2"><input type="text" placeholder="Line Stop Non Mesin Item" class="w-full input-field rounded-lg px-4 py-2 line-stop-non-mesin-item">
         </div><button type="button" onclick="addLineStopNonMesin()" class="mt-3 btn-success text-white px-4 py-2 rounded-lg font-semibold"> â• Add Item </button>
        </div>
       </div><!-- Minor Stop Items -->
       <div class="chart-card"><label class="block text-sm font-medium text-gray-700 mb-4">âš ï¸ Minor Stop Items</label>
        <div id="minor-stop-items" class="space-y-2"><input type="text" placeholder="Minor Stop Item" class="w-full input-field rounded-lg px-4 py-2 minor-stop-item">
        </div><button type="button" onclick="addMinorStopItem()" class="mt-3 btn-success text-white px-4 py-2 rounded-lg font-semibold"> â• Add Item </button>
       </div>
       <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4"><button type="submit" id="machine-submit-btn" class="btn-primary text-white px-8 py-3 rounded-lg font-semibold"> ğŸ’¾ Save Machine </button> <button type="button" onclick="cancelMachineForm()" class="bg-gray-500 text-white px-8 py-3 rounded-lg font-semibold hover:bg-gray-600 transition-all"> âŒ Cancel </button>
       </div>
      </form>
     </div><!-- Machine List -->
     <div id="machine-list-container" class="hidden">
      <div class="overflow-x-auto">
       <table class="min-w-full table-auto">
        <thead>
         <tr>
          <th class="px-2 md:px-4 py-3 text-left text-xs md:text-sm font-medium">Name</th>
          <th class="px-2 md:px-4 py-3 text-left text-xs md:text-sm font-medium">Area</th>
          <th class="px-2 md:px-4 py-3 text-left text-xs md:text-sm font-medium">Target/Min</th>
          <th class="px-2 md:px-4 py-3 text-left text-xs md:text-sm font-medium">PIC</th>
          <th class="px-2 md:px-4 py-3 text-left text-xs md:text-sm font-medium">Actions</th>
         </tr>
        </thead>
        <tbody id="machine-list">
        </tbody>
       </table>
      </div>
     </div>
    </div>
   </section><!-- Export Section -->
   <section id="export-section" class="section hidden max-w-4xl mx-auto px-4 md:px-6">
    <div class="glass-card rounded-2xl p-6 md:p-8 animate-fade-in">
     <h2 class="section-header mb-6">ğŸ“¥ Export Data</h2><!-- Export Filters -->
     <div class="filter-card mb-6">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
       <div><label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“… Start Date</label> <input type="date" id="export-start-date" class="w-full input-field rounded-lg px-4 py-2">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“… End Date</label> <input type="date" id="export-end-date" class="w-full input-field rounded-lg px-4 py-2">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">ğŸ­ Machine</label> <select id="export-machine" class="w-full input-field rounded-lg px-4 py-2"> <option value="">All Machines</option> </select>
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“„ Format</label> <select id="export-format" class="w-full input-field rounded-lg px-4 py-2"> <option value="csv">CSV</option> <option value="excel">Excel</option> </select>
       </div>
      </div>
     </div>
     <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4"><button onclick="exportData()" id="export-btn" class="btn-success text-white px-8 py-3 rounded-lg font-semibold"> ğŸ“¥ Export Data </button> <button onclick="previewExport()" class="btn-primary text-white px-8 py-3 rounded-lg font-semibold"> ğŸ‘ï¸ Preview </button>
     </div><!-- Export Preview -->
     <div id="export-preview" class="mt-6 hidden">
      <h3 class="text-lg font-semibold text-gray-700 mb-4">ğŸ‘ï¸ Export Preview</h3>
      <div class="chart-card">
       <p id="preview-info" class="text-sm text-gray-600 mb-4"></p>
       <div class="overflow-x-auto max-h-96">
        <table class="min-w-full table-auto text-xs">
         <thead>
          <tr id="preview-header"></tr>
         </thead>
         <tbody id="preview-body"></tbody>
        </table>
       </div>
      </div>
     </div>
    </div>
   </section>
  </div>
  <script>
        // Global variables
        let currentData = [];
        let machines = [];
        let oeeRecords = [];
        let charts = {};
        let isAuthenticated = false;
        let supabaseClient = null;
        let inactivityTimer = null;
        const INACTIVITY_TIMEOUT = 20000; // 20 seconds
        let dashboardRefreshInterval = null;
        const DASHBOARD_REFRESH_INTERVAL = 900000; // 15 minutes

        // Supabase Configuration
        const SUPABASE_URL = 'https://ehespstzpubqkovkykby.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVoZXNwc3R6cHVicWtvdmt5a2J5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1MDY4MjUsImV4cCI6MjA4MTA4MjgyNX0.XTuuHksJVe8ZEwcN5gshXNz7WqEWVPr10eIsYO-zar4';

        // Make all functions globally accessible
        window.showSection = showSection;
        window.calculateTargetRecommendation = calculateTargetRecommendation;
        window.loadMachineTemplate = loadMachineTemplate;
        window.calculateOEE = calculateOEE;
        window.resetForm = resetForm;
        window.checkPassword = checkPassword;
        window.showMachineForm = showMachineForm;
        window.cancelMachineForm = cancelMachineForm;
        window.addODTItem = addODTItem;
        window.removeODTItem = removeODTItem;
        window.addLineStopMesin = addLineStopMesin;
        window.addLineStopNonMesin = addLineStopNonMesin;
        window.addMinorStopItem = addMinorStopItem;
        window.editMachine = editMachine;
        window.deleteMachine = deleteMachine;
        window.confirmDeleteMachine = confirmDeleteMachine;
        window.cancelDeleteMachine = cancelDeleteMachine;
        window.applyDashboardFilters = applyDashboardFilters;
        window.exportData = exportData;
        window.previewExport = previewExport;
        window.toggleODTInput = toggleODTInput;
        window.updateODTOvertimeDisplay = updateODTOvertimeDisplay;
        window.checkWRRequirement = checkWRRequirement;
        window.checkCustomWRRequirement = checkCustomWRRequirement;

        // Initialize application
        async function init() {
            // Initialize Supabase
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            
            // Load data from Supabase
            await loadDataFromSupabase();
            
            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('input-date').value = today;
            document.getElementById('filter-start-date').value = today;
            document.getElementById('filter-end-date').value = today;
            document.getElementById('export-start-date').value = today;
            document.getElementById('export-end-date').value = today;
            
            // Show dashboard by default
            showSection('dashboard');
            
            // Setup form handlers
            setupFormHandlers();
            
            // Setup machine management activity tracking
            setupMachineManagementActivity();
            
            // Update operator filter dropdown
            updateOperatorFilter();
            
            // Start dashboard auto-refresh
            startDashboardAutoRefresh();
        }

        // Start dashboard auto-refresh
        function startDashboardAutoRefresh() {
            // Clear existing interval if any
            if (dashboardRefreshInterval) {
                clearInterval(dashboardRefreshInterval);
            }
            
            // Set new interval for 15 minutes
            dashboardRefreshInterval = setInterval(async () => {
                // Only refresh if dashboard section is visible
                const dashboardSection = document.getElementById('dashboard-section');
                if (!dashboardSection.classList.contains('hidden')) {
                    await loadDataFromSupabase();
                    updateDashboard();
                    showToast('Dashboard refreshed automatically', 'info');
                }
            }, DASHBOARD_REFRESH_INTERVAL);
        }

        // Load data from Supabase
        async function loadDataFromSupabase() {
            try {
                const { data, error } = await supabaseClient
                    .from('oee_data')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                if (data) {
                    machines = data.filter(item => item.type === 'machine');
                    oeeRecords = data.filter(item => item.type === 'oee_record');
                    
                    updateMachineSelects();
                    updateMachineList();
                    updateDashboard();
                    updateOperatorFilter();
                }
            } catch (error) {
                console.error('Error loading data from Supabase:', error);
                showToast('Error loading data from database', 'error');
            }
        }

        // Save data to Supabase
        async function saveToSupabase(data) {
            try {
                const { error } = await supabaseClient
                    .from('oee_data')
                    .insert([data]);
                
                if (error) throw error;
                
                return true;
            } catch (error) {
                console.error('Error saving to Supabase:', error);
                showToast('Error saving to database: ' + error.message, 'error');
                return false;
            }
        }

        // Update data in Supabase
        async function updateInSupabase(id, data) {
            try {
                const { error } = await supabaseClient
                    .from('oee_data')
                    .update(data)
                    .eq('id', id);
                
                if (error) throw error;
                
                return true;
            } catch (error) {
                console.error('Error updating in Supabase:', error);
                showToast('Error updating database: ' + error.message, 'error');
                return false;
            }
        }

        // Delete data from Supabase
        async function deleteFromSupabase(id) {
            try {
                const { error } = await supabaseClient
                    .from('oee_data')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                return true;
            } catch (error) {
                console.error('Error deleting from Supabase:', error);
                showToast('Error deleting from database: ' + error.message, 'error');
                return false;
            }
        }

        // Update operator filter dropdown
        function updateOperatorFilter() {
            const operatorSelect = document.getElementById('filter-operator');
            if (!operatorSelect) return;
            
            const currentValue = operatorSelect.value;
            
            // Get unique operators from records
            const operators = [...new Set(oeeRecords.map(record => record.pic))].sort();
            
            // Clear existing options except first
            while (operatorSelect.children.length > 1) {
                operatorSelect.removeChild(operatorSelect.lastChild);
            }
            
            // Add operator options
            operators.forEach(operator => {
                const option = document.createElement('option');
                option.value = operator;
                option.textContent = operator;
                operatorSelect.appendChild(option);
            });
            
            // Restore selection if still valid
            if (currentValue && operators.includes(currentValue)) {
                operatorSelect.value = currentValue;
            }
        }

        // Setup form handlers
        function setupFormHandlers() {
            // OEE Form - Prevent Enter key from submitting
            const oeeForm = document.getElementById('oee-form');
            oeeForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                // Form will only submit via button click
            });
            
            // Prevent Enter key on OEE form inputs
            oeeForm.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && e.target.tagName !== 'BUTTON') {
                    e.preventDefault();
                    return false;
                }
            });
            
            // Machine Form
            document.getElementById('machine-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                await submitMachineData();
            });
            
            // Auto-uppercase for all text inputs
            document.addEventListener('input', (e) => {
                if (e.target.type === 'text' && !e.target.classList.contains('no-uppercase')) {
                    const cursorPos = e.target.selectionStart;
                    e.target.value = e.target.value.toUpperCase();
                    e.target.setSelectionRange(cursorPos, cursorPos);
                }
            });
        }

        // Navigation
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Show selected section
            const targetSection = document.getElementById(`${sectionName}-section`);
            if (targetSection) {
                targetSection.classList.remove('hidden');
            }
            
            // Update navigation
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-purple-50');
            });
            const activeBtn = document.querySelector(`[data-section="${sectionName}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active', 'bg-purple-50');
            }
            
            // Load section-specific data
            if (sectionName === 'dashboard') {
                updateDashboard();
            }
        }

        // Password protection
        function checkPassword() {
            const password = document.getElementById('admin-password').value;
            if (password === 'admin123') {
                isAuthenticated = true;
                document.getElementById('password-protection').classList.add('hidden');
                document.getElementById('machine-list-container').classList.remove('hidden');
                updateMachineList();
                startInactivityTimer();
                document.getElementById('admin-password').value = '';
            } else {
                showToast('Invalid password', 'error');
            }
        }

        function startInactivityTimer() {
            // Clear existing timer
            if (inactivityTimer) {
                clearTimeout(inactivityTimer);
            }
            
            // Start new timer
            inactivityTimer = setTimeout(() => {
                lockMachineManagement();
            }, INACTIVITY_TIMEOUT);
        }

        function resetInactivityTimer() {
            if (isAuthenticated) {
                startInactivityTimer();
            }
        }

        function lockMachineManagement() {
            isAuthenticated = false;
            document.getElementById('password-protection').classList.remove('hidden');
            document.getElementById('machine-list-container').classList.add('hidden');
            document.getElementById('machine-form-container').classList.add('hidden');
            showToast('Session locked due to inactivity. Please re-enter password.', 'info');
            
            if (inactivityTimer) {
                clearTimeout(inactivityTimer);
                inactivityTimer = null;
            }
        }

        // Add event listeners for user activity in machine management section
        function setupMachineManagementActivity() {
            const machineSection = document.getElementById('machines-section');
            
            ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click', 'input'].forEach(event => {
                machineSection.addEventListener(event, resetInactivityTimer, true);
            });
        }

        // Machine Management
        function showMachineForm() {
            if (!isAuthenticated) {
                showToast('Please authenticate first', 'error');
                return;
            }
            document.getElementById('machine-form-container').classList.remove('hidden');
            document.getElementById('edit-machine-id').value = '';
            document.getElementById('machine-form').reset();
            resetMachineForm();
            resetInactivityTimer();
        }

        function cancelMachineForm() {
            document.getElementById('machine-form-container').classList.add('hidden');
        }

        function resetMachineForm() {
            // Reset ODT items
            const odtContainer = document.getElementById('odt-items');
            odtContainer.innerHTML = `
                <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2">
                    <input type="text" placeholder="ODT Name" class="flex-1 input-field rounded-lg px-4 py-2 odt-name">
                    <input type="number" placeholder="Standard Time (min)" class="w-full md:w-32 input-field rounded-lg px-4 py-2 odt-time">
                    <button type="button" onclick="removeODTItem(this)" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-all">Remove</button>
                </div>
            `;
            
            // Reset Line Stop items
            document.getElementById('line-stop-mesin').innerHTML = `
                <input type="text" placeholder="Line Stop Mesin Item" class="w-full input-field rounded-lg px-4 py-2 line-stop-mesin-item">
            `;
            document.getElementById('line-stop-non-mesin').innerHTML = `
                <input type="text" placeholder="Line Stop Non Mesin Item" class="w-full input-field rounded-lg px-4 py-2 line-stop-non-mesin-item">
            `;
            
            // Reset Minor Stop items
            document.getElementById('minor-stop-items').innerHTML = `
                <input type="text" placeholder="Minor Stop Item" class="w-full input-field rounded-lg px-4 py-2 minor-stop-item">
            `;
        }

        function addODTItem() {
            const container = document.getElementById('odt-items');
            const div = document.createElement('div');
            div.className = 'flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2';
            div.innerHTML = `
                <input type="text" placeholder="ODT Name" class="flex-1 input-field rounded-lg px-4 py-2 odt-name">
                <input type="number" placeholder="Standard Time (min)" class="w-full md:w-32 input-field rounded-lg px-4 py-2 odt-time">
                <button type="button" onclick="removeODTItem(this)" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-all">Remove</button>
            `;
            container.appendChild(div);
        }

        function removeODTItem(button) {
            button.parentElement.remove();
        }

        function addLineStopMesin() {
            const container = document.getElementById('line-stop-mesin');
            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = 'Line Stop Mesin Item';
            input.className = 'w-full input-field rounded-lg px-4 py-2 line-stop-mesin-item';
            container.appendChild(input);
        }

        function addLineStopNonMesin() {
            const container = document.getElementById('line-stop-non-mesin');
            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = 'Line Stop Non Mesin Item';
            input.className = 'w-full input-field rounded-lg px-4 py-2 line-stop-non-mesin-item';
            container.appendChild(input);
        }

        function addMinorStopItem() {
            const container = document.getElementById('minor-stop-items');
            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = 'Minor Stop Item';
            input.className = 'w-full input-field rounded-lg px-4 py-2 minor-stop-item';
            container.appendChild(input);
        }

        async function submitMachineData() {
            const submitBtn = document.getElementById('machine-submit-btn');
            submitBtn.classList.add('loading');
            submitBtn.textContent = 'Saving...';
            
            try {
                const machineId = document.getElementById('edit-machine-id').value;
                const name = document.getElementById('machine-name').value.toUpperCase();
                
                // Check for duplicate names
                const existingMachine = machines.find(m => m.name === name && m.id !== machineId);
                if (existingMachine) {
                    showToast('Machine name already exists', 'error');
                    return;
                }
                
                // Collect ODT items
                const odtItems = [];
                document.querySelectorAll('#odt-items > div').forEach(div => {
                    const nameInput = div.querySelector('.odt-name');
                    const timeInput = div.querySelector('.odt-time');
                    if (nameInput && timeInput && nameInput.value && timeInput.value) {
                        odtItems.push({
                            name: nameInput.value.toUpperCase(),
                            standardTime: parseInt(timeInput.value)
                        });
                    }
                });
                
                // Collect Line Stop items
                const lineStopMesin = [];
                document.querySelectorAll('.line-stop-mesin-item').forEach(input => {
                    if (input.value) lineStopMesin.push(input.value.toUpperCase());
                });
                
                const lineStopNonMesin = [];
                document.querySelectorAll('.line-stop-non-mesin-item').forEach(input => {
                    if (input.value) lineStopNonMesin.push(input.value.toUpperCase());
                });
                
                // Collect Minor Stop items
                const minorStopItems = [];
                document.querySelectorAll('.minor-stop-item').forEach(input => {
                    if (input.value) minorStopItems.push(input.value.toUpperCase());
                });
                
                const machineData = {
                    id: machineId || generateId(),
                    type: 'machine',
                    name: name,
                    area: document.getElementById('machine-area').value,
                    target_per_minute: parseInt(document.getElementById('machine-target').value),
                    pic: document.getElementById('machine-pic').value.toUpperCase(),
                    odt_items: JSON.stringify(odtItems),
                    line_stop_mesin: JSON.stringify(lineStopMesin),
                    line_stop_non_mesin: JSON.stringify(lineStopNonMesin),
                    minor_stop_items: JSON.stringify(minorStopItems),
                    created_at: new Date().toISOString()
                };
                
                // Save to Supabase
                let success = false;
                if (machineId) {
                    // Update existing machine
                    success = await updateInSupabase(machineId, machineData);
                    if (success) {
                        const index = machines.findIndex(m => m.id === machineId);
                        if (index !== -1) {
                            machines[index] = machineData;
                        }
                    }
                } else {
                    // Insert new machine
                    success = await saveToSupabase(machineData);
                    if (success) {
                        machines.push(machineData);
                    }
                }
                
                if (success) {
                    updateMachineList();
                    updateMachineSelects();
                    showToast('Machine saved successfully', 'success');
                    cancelMachineForm();
                }
                
            } catch (error) {
                console.error('Machine save error:', error);
                showToast('Error saving machine: ' + error.message, 'error');
            } finally {
                submitBtn.classList.remove('loading');
                submitBtn.textContent = 'ğŸ’¾ Save Machine';
            }
        }

        function editMachine(id) {
            const machine = machines.find(m => m.id === id);
            if (!machine) return;
            
            // Fill form with machine data
            document.getElementById('edit-machine-id').value = machine.id;
            document.getElementById('machine-name').value = machine.name;
            document.getElementById('machine-area').value = machine.area;
            document.getElementById('machine-target').value = machine.target_per_minute;
            document.getElementById('machine-pic').value = machine.pic;
            
            // Load ODT items
            const odtItems = JSON.parse(machine.odt_items || '[]');
            const odtContainer = document.getElementById('odt-items');
            odtContainer.innerHTML = '';
            odtItems.forEach(item => {
                const div = document.createElement('div');
                div.className = 'flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2';
                div.innerHTML = `
                    <input type="text" value="${item.name}" class="flex-1 input-field rounded-lg px-4 py-2 odt-name">
                    <input type="number" value="${item.standardTime}" class="w-full md:w-32 input-field rounded-lg px-4 py-2 odt-time">
                    <button type="button" onclick="removeODTItem(this)" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-all">Remove</button>
                `;
                odtContainer.appendChild(div);
            });
            
            // Load Line Stop items
            const lineStopMesin = JSON.parse(machine.line_stop_mesin || '[]');
            const lineStopMesinContainer = document.getElementById('line-stop-mesin');
            lineStopMesinContainer.innerHTML = '';
            lineStopMesin.forEach(item => {
                const input = document.createElement('input');
                input.type = 'text';
                input.value = item;
                input.className = 'w-full input-field rounded-lg px-4 py-2 line-stop-mesin-item';
                lineStopMesinContainer.appendChild(input);
            });
            
            const lineStopNonMesin = JSON.parse(machine.line_stop_non_mesin || '[]');
            const lineStopNonMesinContainer = document.getElementById('line-stop-non-mesin');
            lineStopNonMesinContainer.innerHTML = '';
            lineStopNonMesin.forEach(item => {
                const input = document.createElement('input');
                input.type = 'text';
                input.value = item;
                input.className = 'w-full input-field rounded-lg px-4 py-2 line-stop-non-mesin-item';
                lineStopNonMesinContainer.appendChild(input);
            });
            
            // Load Minor Stop items
            const minorStopItems = JSON.parse(machine.minor_stop_items || '[]');
            const minorStopContainer = document.getElementById('minor-stop-items');
            minorStopContainer.innerHTML = '';
            minorStopItems.forEach(item => {
                const input = document.createElement('input');
                input.type = 'text';
                input.value = item;
                input.className = 'w-full input-field rounded-lg px-4 py-2 minor-stop-item';
                minorStopContainer.appendChild(input);
            });
            
            document.getElementById('machine-form-container').classList.remove('hidden');
        }

        async function deleteMachine(id) {
            // Create inline confirmation
            const row = event.target.closest('tr');
            
            // Store original row data
            row.dataset.machineId = id;
            row.dataset.isDeleting = 'true';
            
            row.innerHTML = `
                <td colspan="5" class="px-4 py-2 text-center bg-red-50">
                    <span class="text-red-600 font-medium">âš ï¸ Yakin mau hapus mesin ini?</span>
                    <button onclick="confirmDeleteMachine('${id}')" class="ml-4 bg-red-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-red-600 transition-all font-semibold">âœ“ Ya, Hapus</button>
                    <button onclick="cancelDeleteMachine(this)" class="ml-2 bg-gray-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-gray-600 transition-all font-semibold">âœ— Batal</button>
                </td>
            `;
        }
        
        async function confirmDeleteMachine(id) {
            try {
                const success = await deleteFromSupabase(id);
                if (success) {
                    machines = machines.filter(m => m.id !== id);
                    updateMachineList();
                    updateMachineSelects();
                    showToast('Mesin berhasil dihapus', 'success');
                }
            } catch (error) {
                showToast('Error menghapus mesin: ' + error.message, 'error');
            }
        }
        
        function cancelDeleteMachine(button) {
            // Just refresh the machine list to restore original state
            updateMachineList();
        }

        function updateMachineList() {
            if (!isAuthenticated) return;
            
            const tbody = document.getElementById('machine-list');
            tbody.innerHTML = '';
            
            machines.forEach(machine => {
                const row = document.createElement('tr');
                row.className = 'border-b';
                row.innerHTML = `
                    <td class="px-2 md:px-4 py-3">${machine.name}</td>
                    <td class="px-2 md:px-4 py-3">${machine.area}</td>
                    <td class="px-2 md:px-4 py-3">${machine.target_per_minute}</td>
                    <td class="px-2 md:px-4 py-3">${machine.pic}</td>
                    <td class="px-2 md:px-4 py-3">
                        <button onclick="editMachine('${machine.id}')" class="bg-blue-500 text-white px-2 md:px-3 py-1 rounded-lg text-xs md:text-sm hover:bg-blue-600 transition-all mr-2">âœï¸ Edit</button>
                        <button onclick="deleteMachine('${machine.id}')" class="bg-red-500 text-white px-2 md:px-3 py-1 rounded-lg text-xs md:text-sm hover:bg-red-600 transition-all">ğŸ—‘ï¸ Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateMachineSelects() {
            const selects = [
                'input-machine',
                'filter-machine',
                'export-machine'
            ];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                const currentValue = select.value;
                
                // Clear existing options except first
                while (select.children.length > 1) {
                    select.removeChild(select.lastChild);
                }
                
                // Add machine options
                machines.forEach(machine => {
                    const option = document.createElement('option');
                    option.value = machine.name;
                    option.textContent = machine.name;
                    select.appendChild(option);
                });
                
                // Restore selection if still valid
                if (currentValue) {
                    select.value = currentValue;
                }
            });
        }

        // OEE Input Functions
        function calculateTargetRecommendation() {
            const machineName = document.getElementById('input-machine').value;
            const shiftSelect = document.getElementById('input-shift');
            const selectedOption = shiftSelect.options[shiftSelect.selectedIndex];
            
            if (!machineName || !selectedOption.dataset.minutes) {
                document.getElementById('target-recommendation').innerHTML = 'â³ Select shift and machine to see recommendation';
                return;
            }
            
            const machine = machines.find(m => m.name === machineName);
            if (!machine) return;
            
            const shiftMinutes = parseInt(selectedOption.dataset.minutes);
            
            // Calculate total ODT time
            let totalODT = 0;
            document.querySelectorAll('.odt-checkbox').forEach(checkbox => {
                if (checkbox.checked) {
                    const actualInput = checkbox.parentElement.querySelector('.odt-actual');
                    const standard = parseInt(checkbox.dataset.standard);
                    const actual = parseInt(actualInput.value) || standard;
                    totalODT += actual;
                }
            });
            
            // Calculate total Line Stop time (including custom)
            let totalLineStop = 0;
            document.querySelectorAll('.line-stop-mesin-input, .line-stop-non-mesin-input').forEach(input => {
                totalLineStop += parseInt(input.value) || 0;
            });
            
            // Add custom line stop times
            totalLineStop += parseInt(document.getElementById('customLSMesinTime1')?.value) || 0;
            totalLineStop += parseInt(document.getElementById('customLSMesinTime2')?.value) || 0;
            totalLineStop += parseInt(document.getElementById('customLSNonMesinTime1')?.value) || 0;
            totalLineStop += parseInt(document.getElementById('customLSNonMesinTime2')?.value) || 0;
            
            const availableTime = shiftMinutes - totalODT - totalLineStop;
            const recommendedOutput = Math.max(0, availableTime * machine.target_per_minute);
            
            document.getElementById('target-recommendation').innerHTML = `
                <strong>ğŸ¯ Recommended Target Output: ${recommendedOutput.toLocaleString()} units</strong><br>
                <small class="opacity-80">ğŸ“ Calculation: (${shiftMinutes} - ${totalODT} - ${totalLineStop}) Ã— ${machine.target_per_minute} = ${recommendedOutput}</small>
            `;
        }

        function loadMachineTemplate() {
            const machineName = document.getElementById('input-machine').value;
            const machine = machines.find(m => m.name === machineName);
            
            if (!machine) {
                document.getElementById('template-fields').innerHTML = '';
                calculateTargetRecommendation();
                return;
            }
            
            const templateContainer = document.getElementById('template-fields');
            templateContainer.innerHTML = '';
            
            // ODT Section
            const odtItems = JSON.parse(machine.odt_items || '[]');
            if (odtItems.length > 0) {
                const odtSection = document.createElement('div');
                odtSection.className = 'chart-card';
                odtSection.innerHTML = `
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">â±ï¸ ODT (Operational Downtime)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="odt-inputs">
                    </div>
                `;
                templateContainer.appendChild(odtSection);
                
                const odtInputs = document.getElementById('odt-inputs');
                odtItems.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center space-x-3 p-3 bg-purple-50 rounded-lg border-2 border-purple-200';
                    div.innerHTML = `
                        <input type="checkbox" class="odt-checkbox w-5 h-5 text-purple-600" 
                               data-name="${item.name}" data-standard="${item.standardTime}" 
                               onchange="toggleODTInput(this); calculateOEE(); calculateTargetRecommendation(); updateODTOvertimeDisplay();">
                        <label class="flex-1 text-sm font-medium text-gray-700">${item.name} (Standard: ${item.standardTime} min)</label>
                        <input type="number" class="w-24 input-field rounded-lg px-3 py-2 text-sm odt-actual" 
                               data-name="${item.name}" data-standard="${item.standardTime}" 
                               onchange="calculateOEE(); calculateTargetRecommendation(); updateODTOvertimeDisplay();" 
                               placeholder="Actual" disabled>
                    `;
                    odtInputs.appendChild(div);
                });
            }
            
            // Line Stop Section with Custom Slots
            const lineStopMesin = JSON.parse(machine.line_stop_mesin || '[]');
            const lineStopNonMesin = JSON.parse(machine.line_stop_non_mesin || '[]');
            
            if (lineStopMesin.length > 0 || lineStopNonMesin.length > 0) {
                const lineStopSection = document.createElement('div');
                lineStopSection.className = 'chart-card';
                lineStopSection.innerHTML = `
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">ğŸ”´ Line Stop</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h4 class="font-medium text-gray-600 mb-3">ğŸ”´ Line Stop Mesin</h4>
                            <div id="line-stop-mesin-inputs" class="space-y-2"></div>
                            
                            <!-- Custom Line Stop Mesin Slots -->
                            <div class="mt-4 space-y-3">
                                <div class="bg-yellow-50 p-4 rounded-lg border-2 border-yellow-300">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">âš ï¸ Custom Line Stop Mesin 1</label>
                                    <input type="text" id="customLSMesinName1" class="w-full input-field rounded-lg px-3 py-2 mb-2 uppercase" 
                                           placeholder="Nama Problem (opsional)" style="text-transform: uppercase;">
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                                        <input type="number" id="customLSMesinTime1" class="input-field rounded-lg px-3 py-2" 
                                               placeholder="Durasi (menit)" onchange="calculateOEE(); calculateTargetRecommendation(); checkCustomWRRequirement('customLSMesinTime1', 'customLSMesinWR1');">
                                        <input type="text" id="customLSMesinAction1" class="input-field rounded-lg px-3 py-2 uppercase" 
                                               placeholder="Action" style="text-transform: uppercase;">
                                        <input type="text" id="customLSMesinWR1" class="input-field rounded-lg px-3 py-2 uppercase" 
                                               placeholder="No WR" style="text-transform: uppercase;">
                                    </div>
                                </div>
                                
                                <div class="bg-yellow-50 p-4 rounded-lg border-2 border-yellow-300">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">âš ï¸ Custom Line Stop Mesin 2</label>
                                    <input type="text" id="customLSMesinName2" class="w-full input-field rounded-lg px-3 py-2 mb-2 uppercase" 
                                           placeholder="Nama Problem (opsional)" style="text-transform: uppercase;">
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                                        <input type="number" id="customLSMesinTime2" class="input-field rounded-lg px-3 py-2" 
                                               placeholder="Durasi (menit)" onchange="calculateOEE(); calculateTargetRecommendation(); checkCustomWRRequirement('customLSMesinTime2', 'customLSMesinWR2');">
                                        <input type="text" id="customLSMesinAction2" class="input-field rounded-lg px-3 py-2 uppercase" 
                                               placeholder="Action" style="text-transform: uppercase;">
                                        <input type="text" id="customLSMesinWR2" class="input-field rounded-lg px-3 py-2 uppercase" 
                                               placeholder="No WR" style="text-transform: uppercase;">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-600 mb-3">ğŸŸ¡ Line Stop Non Mesin</h4>
                            <div id="line-stop-non-mesin-inputs" class="space-y-2"></div>
                            
                            <!-- Custom Line Stop Non Mesin Slots -->
                            <div class="mt-4 space-y-3">
                                <div class="bg-yellow-50 p-4 rounded-lg border-2 border-yellow-300">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">âš ï¸ Custom Line Stop Non Mesin 1</label>
                                    <input type="text" id="customLSNonMesinName1" class="w-full input-field rounded-lg px-3 py-2 mb-2 uppercase" 
                                           placeholder="Nama Problem (opsional)" style="text-transform: uppercase;">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                        <input type="number" id="customLSNonMesinTime1" class="input-field rounded-lg px-3 py-2" 
                                               placeholder="Durasi (menit)" onchange="calculateOEE(); calculateTargetRecommendation();">
                                        <input type="text" id="customLSNonMesinAction1" class="input-field rounded-lg px-3 py-2 uppercase" 
                                               placeholder="Action" style="text-transform: uppercase;">
                                    </div>
                                </div>
                                
                                <div class="bg-yellow-50 p-4 rounded-lg border-2 border-yellow-300">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">âš ï¸ Custom Line Stop Non Mesin 2</label>
                                    <input type="text" id="customLSNonMesinName2" class="w-full input-field rounded-lg px-3 py-2 mb-2 uppercase" 
                                           placeholder="Nama Problem (opsional)" style="text-transform: uppercase;">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                        <input type="number" id="customLSNonMesinTime2" class="input-field rounded-lg px-3 py-2" 
                                               placeholder="Durasi (menit)" onchange="calculateOEE(); calculateTargetRecommendation();">
                                        <input type="text" id="customLSNonMesinAction2" class="input-field rounded-lg px-3 py-2 uppercase" 
                                               placeholder="Action" style="text-transform: uppercase;">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ODT Overtime Display Container -->
                            <div id="odt-overtime-container" class="mt-4 space-y-2"></div>
                        </div>
                    </div>
                `;
                templateContainer.appendChild(lineStopSection);
                
                const lineStopMesinInputs = document.getElementById('line-stop-mesin-inputs');
                lineStopMesin.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'mb-2 p-3 bg-red-50 rounded-lg border-2 border-red-200';
                    div.innerHTML = `
                        <label class="block text-sm font-medium text-gray-700 mb-2">${item}</label>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                            <input type="number" class="input-field rounded-lg px-3 py-2 line-stop-mesin-input" 
                                   data-name="${item}" onchange="checkWRRequirement(); calculateOEE(); calculateTargetRecommendation();" placeholder="Durasi (menit)">
                            <input type="text" class="input-field rounded-lg px-3 py-2 line-stop-mesin-action uppercase" 
                                   data-name="${item}" placeholder="Action" style="text-transform: uppercase;">
                            <input type="text" class="input-field rounded-lg px-3 py-2 line-stop-mesin-wr" 
                                   data-name="${item}" placeholder="No WR" style="text-transform: uppercase;">
                        </div>
                    `;
                    lineStopMesinInputs.appendChild(div);
                });
                
                const lineStopNonMesinInputs = document.getElementById('line-stop-non-mesin-inputs');
                lineStopNonMesin.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'mb-2 p-3 bg-yellow-50 rounded-lg border-2 border-yellow-200';
                    div.innerHTML = `
                        <label class="block text-sm font-medium text-gray-700 mb-2">${item}</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                            <input type="number" class="input-field rounded-lg px-3 py-2 line-stop-non-mesin-input" 
                                   data-name="${item}" onchange="calculateOEE(); calculateTargetRecommendation();" placeholder="Durasi (menit)">
                            <input type="text" class="input-field rounded-lg px-3 py-2 line-stop-non-mesin-action uppercase" 
                                   data-name="${item}" placeholder="Action" style="text-transform: uppercase;">
                        </div>
                    `;
                    lineStopNonMesinInputs.appendChild(div);
                });
            }
            
            // Minor Stop Section
            const minorStopItems = JSON.parse(machine.minor_stop_items || '[]');
            if (minorStopItems.length > 0) {
                const minorStopSection = document.createElement('div');
                minorStopSection.className = 'chart-card';
                minorStopSection.innerHTML = `
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">âš ï¸ Minor Stop</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="minor-stop-inputs">
                    </div>
                `;
                templateContainer.appendChild(minorStopSection);
                
                const minorStopInputs = document.getElementById('minor-stop-inputs');
                minorStopItems.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'p-3 bg-orange-50 rounded-lg border-2 border-orange-200';
                    div.innerHTML = `
                        <label class="block text-sm font-medium text-gray-700 mb-2">${item}</label>
                        <input type="number" class="w-full input-field rounded-lg px-3 py-2 minor-stop-input" 
                               data-name="${item}" onchange="calculateOEE()" placeholder="Frequency count">
                    `;
                    minorStopInputs.appendChild(div);
                });
            }
        }

        function checkCustomWRRequirement(timeInputId, wrInputId) {
            const timeInput = document.getElementById(timeInputId);
            const wrInput = document.getElementById(wrInputId);
            if (!timeInput || !wrInput) return;
            
            const duration = parseInt(timeInput.value) || 0;
            
            if (duration > 179) {
                wrInput.required = true;
                wrInput.style.borderColor = '#ef4444';
                wrInput.style.backgroundColor = '#fef2f2';
                wrInput.placeholder = 'WAJIB ISI NO WR!';
            } else {
                wrInput.required = false;
                wrInput.style.borderColor = '#e2e8f0';
                wrInput.style.backgroundColor = 'white';
                wrInput.placeholder = 'No WR';
            }
        }

        function toggleODTInput(checkbox) {
            const actualInput = checkbox.parentElement.querySelector('.odt-actual');
            if (checkbox.checked) {
                actualInput.disabled = false;
                actualInput.focus();
            } else {
                actualInput.disabled = true;
                actualInput.value = '';
            }
        }
        
        function updateODTOvertimeDisplay() {
            const container = document.getElementById('odt-overtime-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Check all ODT items for overtime
            document.querySelectorAll('.odt-checkbox').forEach(checkbox => {
                if (checkbox.checked) {
                    const name = checkbox.dataset.name;
                    const standard = parseInt(checkbox.dataset.standard);
                    const actualInput = checkbox.parentElement.querySelector('.odt-actual');
                    const actual = parseInt(actualInput.value) || standard;
                    
                    if (actual > standard) {
                        const overtime = actual - standard;
                        const overtimeName = `${name} Overtime`;
                        
                        const div = document.createElement('div');
                        div.className = 'bg-orange-100 p-4 rounded-lg border-2 border-orange-400';
                        div.innerHTML = `
                            <label class="block text-sm font-medium text-orange-700 mb-2">
                                ğŸ”” ${overtimeName} (Auto-calculated)
                            </label>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                <input type="number" value="${overtime}" 
                                       class="input-field rounded-lg px-3 py-2 bg-orange-50" 
                                       disabled readonly>
                                <input type="text" value="ODT MELEBIHI STANDARD" 
                                       class="input-field rounded-lg px-3 py-2 bg-orange-50 uppercase" 
                                       disabled readonly>
                            </div>
                            <p class="text-xs text-orange-600 mt-2">
                                â„¹ï¸ ODT Overtime otomatis masuk ke Line Stop Non Mesin (Standard: ${standard} min, Actual: ${actual} min)
                            </p>
                        `;
                        container.appendChild(div);
                    }
                }
            });
        }

        function checkWRRequirement() {
            // Check each line stop mesin item individually
            document.querySelectorAll('.line-stop-mesin-input').forEach(input => {
                const duration = parseInt(input.value) || 0;
                const wrInput = input.parentElement.querySelector('.line-stop-mesin-wr');
                
                if (duration > 179) {
                    wrInput.required = true;
                    wrInput.style.borderColor = '#ef4444';
                    wrInput.style.backgroundColor = '#fef2f2';
                    wrInput.placeholder = 'WAJIB ISI NO WR!';
                } else {
                    wrInput.required = false;
                    wrInput.style.borderColor = '#e2e8f0';
                    wrInput.style.backgroundColor = 'white';
                    wrInput.placeholder = 'No WR';
                }
            });
        }

        function calculateOEE() {
            const machineName = document.getElementById('input-machine').value;
            const machine = machines.find(m => m.name === machineName);
            
            if (!machine) return;
            
            const actualOutput = parseInt(document.getElementById('input-actual-output').value) || 0;
            const reject = parseInt(document.getElementById('input-reject').value) || 0;
            
            // Get shift duration
            const shiftSelect = document.getElementById('input-shift');
            const selectedOption = shiftSelect.options[shiftSelect.selectedIndex];
            const shiftMinutes = selectedOption.dataset.minutes ? parseInt(selectedOption.dataset.minutes) : 480;
            
            // Calculate ODT times
            let totalODT = 0;
            document.querySelectorAll('.odt-checkbox').forEach(checkbox => {
                if (checkbox.checked) {
                    const standard = parseInt(checkbox.dataset.standard);
                    totalODT += standard;
                }
            });
            
            // Calculate Line Stop Mesin total (including custom)
            let totalLineStopMesin = 0;
            document.querySelectorAll('.line-stop-mesin-input').forEach(input => {
                totalLineStopMesin += parseInt(input.value) || 0;
            });
            
            const customMesin1Time = parseInt(document.getElementById('customLSMesinTime1')?.value) || 0;
            const customMesin2Time = parseInt(document.getElementById('customLSMesinTime2')?.value) || 0;
            totalLineStopMesin += customMesin1Time + customMesin2Time;
            
            // Calculate Line Stop Non Mesin total (including custom)
            let totalLineStopNonMesin = 0;
            document.querySelectorAll('.line-stop-non-mesin-input').forEach(input => {
                totalLineStopNonMesin += parseInt(input.value) || 0;
            });
            
            const customNonMesin1Time = parseInt(document.getElementById('customLSNonMesinTime1')?.value) || 0;
            const customNonMesin2Time = parseInt(document.getElementById('customLSNonMesinTime2')?.value) || 0;
            totalLineStopNonMesin += customNonMesin1Time + customNonMesin2Time;
            
            // Add ODT overtimes to Line Stop Non Mesin
            document.querySelectorAll('.odt-checkbox').forEach(checkbox => {
                if (checkbox.checked) {
                    const standard = parseInt(checkbox.dataset.standard);
                    const actualInput = checkbox.parentElement.querySelector('.odt-actual');
                    const actual = parseInt(actualInput.value) || standard;
                    
                    if (actual > standard) {
                        totalLineStopNonMesin += (actual - standard);
                    }
                }
            });
            
            // Calculate total downtime
            const totalDowntime = totalODT + totalLineStopMesin + totalLineStopNonMesin;
            
            // Calculate target output
            const availableTime = shiftMinutes - totalDowntime;
            const targetOutput = availableTime * machine.target_per_minute;
            
            // Calculate OEE components
            const workTimeMinusODT = shiftMinutes - totalODT;
            const availability = workTimeMinusODT > 0 ? ((workTimeMinusODT - totalLineStopMesin - totalLineStopNonMesin) / workTimeMinusODT) * 100 : 0;
            const performance = targetOutput > 0 ? (actualOutput / targetOutput) * 100 : 0;
            const quality = actualOutput > 0 ? ((actualOutput - reject) / actualOutput) * 100 : 0;
            const oee = (availability * performance * quality) / 10000;
            
            // Update display
            document.getElementById('calc-availability').textContent = availability.toFixed(1) + '%';
            document.getElementById('calc-performance').textContent = performance.toFixed(1) + '%';
            document.getElementById('calc-quality').textContent = quality.toFixed(1) + '%';
            document.getElementById('calc-oee').textContent = oee.toFixed(1) + '%';
        }

        async function submitOEEData() {
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.classList.add('loading');
            submitBtn.textContent = 'Menyimpan...';
            
            try {
                const machineName = document.getElementById('input-machine').value;
                const machine = machines.find(m => m.name === machineName);
                
                if (!machine) {
                    throw new Error('Silakan pilih mesin');
                }
                
                // Check if OEE is 0%
                const oeeValue = parseFloat(document.getElementById('calc-oee').textContent);
                if (oeeValue === 0) {
                    showToast('OEE 0% tidak bisa disimpan. Periksa kembali data Anda.', 'error');
                    return;
                }
                
                // Check WR requirement for line stop mesin > 179 minutes
                let wrValidationFailed = false;
                document.querySelectorAll('.line-stop-mesin-input').forEach(input => {
                    const duration = parseInt(input.value) || 0;
                    const wrInput = input.parentElement.querySelector('.line-stop-mesin-wr');
                    const problemName = input.dataset.name;
                    
                    if (duration > 179 && !wrInput.value.trim()) {
                        showToast(`No WR wajib diisi untuk ${problemName} (durasi ${duration} menit > 179 menit)`, 'error');
                        wrValidationFailed = true;
                    }
                });
                
                // Check custom line stop mesin WR requirement
                const customMesin1Time = parseInt(document.getElementById('customLSMesinTime1')?.value) || 0;
                const customMesin1WR = document.getElementById('customLSMesinWR1')?.value.trim();
                const customMesin1Name = document.getElementById('customLSMesinName1')?.value.trim() || 'CUSTOM LS MESIN 1';
                if (customMesin1Time > 179 && !customMesin1WR) {
                    showToast(`No WR wajib diisi untuk ${customMesin1Name} (durasi ${customMesin1Time} menit > 179 menit)`, 'error');
                    wrValidationFailed = true;
                }
                
                const customMesin2Time = parseInt(document.getElementById('customLSMesinTime2')?.value) || 0;
                const customMesin2WR = document.getElementById('customLSMesinWR2')?.value.trim();
                const customMesin2Name = document.getElementById('customLSMesinName2')?.value.trim() || 'CUSTOM LS MESIN 2';
                if (customMesin2Time > 179 && !customMesin2WR) {
                    showToast(`No WR wajib diisi untuk ${customMesin2Name} (durasi ${customMesin2Time} menit > 179 menit)`, 'error');
                    wrValidationFailed = true;
                }
                
                if (wrValidationFailed) {
                    return;
                }
                
                // Check Action requirement for all line stops with duration > 0
                let actionValidationFailed = false;
                
                // Check Line Stop Mesin actions
                document.querySelectorAll('.line-stop-mesin-input').forEach(input => {
                    const duration = parseInt(input.value) || 0;
                    const actionInput = input.parentElement.querySelector('.line-stop-mesin-action');
                    const problemName = input.dataset.name;
                    
                    if (duration > 0 && !actionInput.value.trim()) {
                        showToast(`Action wajib diisi untuk Line Stop Mesin: ${problemName}`, 'error');
                        actionInput.style.borderColor = '#ef4444';
                        actionInput.style.backgroundColor = '#fef2f2';
                        actionValidationFailed = true;
                    }
                });
                
                // Check custom line stop mesin actions
                if (customMesin1Time > 0 && !document.getElementById('customLSMesinAction1')?.value.trim()) {
                    showToast(`Action wajib diisi untuk ${customMesin1Name}`, 'error');
                    document.getElementById('customLSMesinAction1').style.borderColor = '#ef4444';
                    document.getElementById('customLSMesinAction1').style.backgroundColor = '#fef2f2';
                    actionValidationFailed = true;
                }
                
                if (customMesin2Time > 0 && !document.getElementById('customLSMesinAction2')?.value.trim()) {
                    showToast(`Action wajib diisi untuk ${customMesin2Name}`, 'error');
                    document.getElementById('customLSMesinAction2').style.borderColor = '#ef4444';
                    document.getElementById('customLSMesinAction2').style.backgroundColor = '#fef2f2';
                    actionValidationFailed = true;
                }
                
                // Check Line Stop Non Mesin actions
                document.querySelectorAll('.line-stop-non-mesin-input').forEach(input => {
                    const duration = parseInt(input.value) || 0;
                    const actionInput = input.parentElement.querySelector('.line-stop-non-mesin-action');
                    const problemName = input.dataset.name;
                    
                    if (duration > 0 && !actionInput.value.trim()) {
                        showToast(`Action wajib diisi untuk Line Stop Non Mesin: ${problemName}`, 'error');
                        actionInput.style.borderColor = '#ef4444';
                        actionInput.style.backgroundColor = '#fef2f2';
                        actionValidationFailed = true;
                    }
                });
                
                // Check custom line stop non mesin actions
                const customNonMesin1Time = parseInt(document.getElementById('customLSNonMesinTime1')?.value) || 0;
                const customNonMesin1Name = document.getElementById('customLSNonMesinName1')?.value.trim() || 'CUSTOM LS NON MESIN 1';
                if (customNonMesin1Time > 0 && !document.getElementById('customLSNonMesinAction1')?.value.trim()) {
                    showToast(`Action wajib diisi untuk ${customNonMesin1Name}`, 'error');
                    document.getElementById('customLSNonMesinAction1').style.borderColor = '#ef4444';
                    document.getElementById('customLSNonMesinAction1').style.backgroundColor = '#fef2f2';
                    actionValidationFailed = true;
                }
                
                const customNonMesin2Time = parseInt(document.getElementById('customLSNonMesinTime2')?.value) || 0;
                const customNonMesin2Name = document.getElementById('customLSNonMesinName2')?.value.trim() || 'CUSTOM LS NON MESIN 2';
                if (customNonMesin2Time > 0 && !document.getElementById('customLSNonMesinAction2')?.value.trim()) {
                    showToast(`Action wajib diisi untuk ${customNonMesin2Name}`, 'error');
                    document.getElementById('customLSNonMesinAction2').style.borderColor = '#ef4444';
                    document.getElementById('customLSNonMesinAction2').style.backgroundColor = '#fef2f2';
                    actionValidationFailed = true;
                }
                
                if (actionValidationFailed) {
                    return;
                }
                
                // Check if OEE > 100%
                if (oeeValue > 100) {
                    showToast('OEE tidak boleh melebihi 100%. Silakan periksa nilai input Anda.', 'error');
                    return;
                }
                
                // Collect all form data (convert to uppercase)
                const formData = {
                    id: generateId(),
                    type: 'oee_record',
                    date: document.getElementById('input-date').value,
                    shift: document.getElementById('input-shift').value.toUpperCase(),
                    machine: machineName.toUpperCase(),
                    pic: document.getElementById('input-pic').value.toUpperCase(),
                    product: document.getElementById('input-product').value.toUpperCase(),
                    batch: document.getElementById('input-batch').value.toUpperCase(),
                    actual_output: parseInt(document.getElementById('input-actual-output').value),
                    reject: parseInt(document.getElementById('input-reject').value)
                };
                
                // Collect ODT actual times
                const odtActualTimes = {};
                document.querySelectorAll('.odt-checkbox').forEach(checkbox => {
                    const name = checkbox.dataset.name.toUpperCase();
                    const standard = parseInt(checkbox.dataset.standard);
                    
                    if (checkbox.checked) {
                        const actualInput = checkbox.parentElement.querySelector('.odt-actual');
                        const actual = parseInt(actualInput.value) || standard;
                        odtActualTimes[name] = actual;
                    } else {
                        odtActualTimes[name] = 0;
                    }
                });
                formData.odt_actual_times = JSON.stringify(odtActualTimes);
                
                // Collect Line Stop durations with actions and WR numbers (including custom) - UPPERCASE
                const lineStopDurations = { mesin: {}, nonMesin: {} };
                const lineStopActions = { mesin: {}, nonMesin: {} };
                const lineStopWRNumbers = {};
                
                document.querySelectorAll('.line-stop-mesin-input').forEach(input => {
                    const name = input.dataset.name.toUpperCase();
                    const duration = parseInt(input.value) || 0;
                    const actionInput = input.parentElement.querySelector('.line-stop-mesin-action');
                    const wrInput = input.parentElement.querySelector('.line-stop-mesin-wr');
                    
                    lineStopDurations.mesin[name] = duration;
                    lineStopActions.mesin[name] = actionInput.value.toUpperCase() || '';
                    if (wrInput.value) {
                        lineStopWRNumbers[name] = wrInput.value.toUpperCase();
                    }
                });
                
                // Add custom line stop mesin
                if (customMesin1Time > 0) {
                    lineStopDurations.mesin[customMesin1Name.toUpperCase()] = customMesin1Time;
                    lineStopActions.mesin[customMesin1Name.toUpperCase()] = document.getElementById('customLSMesinAction1')?.value.toUpperCase() || '';
                    if (customMesin1WR) {
                        lineStopWRNumbers[customMesin1Name.toUpperCase()] = customMesin1WR.toUpperCase();
                    }
                }
                
                if (customMesin2Time > 0) {
                    lineStopDurations.mesin[customMesin2Name.toUpperCase()] = customMesin2Time;
                    lineStopActions.mesin[customMesin2Name.toUpperCase()] = document.getElementById('customLSMesinAction2')?.value.toUpperCase() || '';
                    if (customMesin2WR) {
                        lineStopWRNumbers[customMesin2Name.toUpperCase()] = customMesin2WR.toUpperCase();
                    }
                }
                
                document.querySelectorAll('.line-stop-non-mesin-input').forEach(input => {
                    const name = input.dataset.name.toUpperCase();
                    const duration = parseInt(input.value) || 0;
                    const actionInput = input.parentElement.querySelector('.line-stop-non-mesin-action');
                    
                    lineStopDurations.nonMesin[name] = duration;
                    lineStopActions.nonMesin[name] = actionInput.value.toUpperCase() || '';
                });
                
                // Add custom line stop non mesin
                if (customNonMesin1Time > 0) {
                    lineStopDurations.nonMesin[customNonMesin1Name.toUpperCase()] = customNonMesin1Time;
                    lineStopActions.nonMesin[customNonMesin1Name.toUpperCase()] = document.getElementById('customLSNonMesinAction1')?.value.toUpperCase() || '';
                }
                
                if (customNonMesin2Time > 0) {
                    lineStopDurations.nonMesin[customNonMesin2Name.toUpperCase()] = customNonMesin2Time;
                    lineStopActions.nonMesin[customNonMesin2Name.toUpperCase()] = document.getElementById('customLSNonMesinAction2')?.value.toUpperCase() || '';
                }
                
                // Add ODT overtimes to Line Stop Non Mesin
                document.querySelectorAll('.odt-checkbox').forEach(checkbox => {
                    if (checkbox.checked) {
                        const name = checkbox.dataset.name.toUpperCase();
                        const standard = parseInt(checkbox.dataset.standard);
                        const actualInput = checkbox.parentElement.querySelector('.odt-actual');
                        const actual = parseInt(actualInput.value) || standard;
                        
                        if (actual > standard) {
                            const overtime = actual - standard;
                            const overtimeName = `${name} OVERTIME`;
                            lineStopDurations.nonMesin[overtimeName] = overtime;
                            lineStopActions.nonMesin[overtimeName] = 'ODT MELEBIHI STANDARD';
                        }
                    }
                });
                
                formData.line_stop_durations = JSON.stringify(lineStopDurations);
                formData.line_stop_actions = JSON.stringify(lineStopActions);
                formData.wr_number = JSON.stringify(lineStopWRNumbers);
                
                // Collect Minor Stop frequencies
                const minorStopFrequencies = {};
                document.querySelectorAll('.minor-stop-input').forEach(input => {
                    minorStopFrequencies[input.dataset.name.toUpperCase()] = parseInt(input.value) || 0;
                });
                formData.minor_stop_frequencies = JSON.stringify(minorStopFrequencies);
                
                // Calculate and store OEE values
                const availability = parseFloat(document.getElementById('calc-availability').textContent);
                const performance = parseFloat(document.getElementById('calc-performance').textContent);
                const quality = parseFloat(document.getElementById('calc-quality').textContent);
                const oee = parseFloat(document.getElementById('calc-oee').textContent);
                
                formData.availability = availability;
                formData.performance = performance;
                formData.quality = quality;
                formData.oee = oee;
                formData.created_at = new Date().toISOString();
                
                // Save to Supabase
                const success = await saveToSupabase(formData);
                
                if (success) {
                    oeeRecords.push(formData);
                    updateDashboard();
                    updateOperatorFilter();
                    
                    showToast('Data OEE berhasil disimpan', 'success');
                    resetForm();
                }
                
            } catch (error) {
                showToast('Error menyimpan data OEE: ' + error.message, 'error');
            } finally {
                submitBtn.classList.remove('loading');
                submitBtn.textContent = 'ğŸ’¾ Simpan Data OEE';
            }
        }

        function resetForm() {
            document.getElementById('oee-form').reset();
            document.getElementById('template-fields').innerHTML = '';
            
            // Reset calculated values
            document.getElementById('calc-availability').textContent = '0%';
            document.getElementById('calc-performance').textContent = '0%';
            document.getElementById('calc-quality').textContent = '0%';
            document.getElementById('calc-oee').textContent = '0%';
            
            // Set today's date
            document.getElementById('input-date').value = new Date().toISOString().split('T')[0];
        }

        // Dashboard Functions
        function updateDashboard() {
            updateKeyMetrics();
            updateCharts();
            updateOperatorPerformance();
            updateDashboardHistoryTable();
        }

        function updateKeyMetrics() {
            const filteredRecords = getFilteredRecords('dashboard');
            
            const avgOEE = filteredRecords.length > 0 
                ? filteredRecords.reduce((sum, record) => sum + record.oee, 0) / filteredRecords.length 
                : 0;
            
            const totalOutput = filteredRecords.reduce((sum, record) => sum + record.actual_output, 0);
            const activeMachines = machines.length;
            
            document.getElementById('avg-oee').textContent = avgOEE.toFixed(1) + '%';
            document.getElementById('total-output').textContent = totalOutput.toLocaleString();
            document.getElementById('active-machines').textContent = activeMachines.toLocaleString();
        }

        function updateCharts() {
            const filteredRecords = getFilteredRecords('dashboard');
            
            // OEE Trend Chart (Last 10 records)
            const last10Records = filteredRecords.slice(-10);
            updateOEETrendChart(last10Records);
            
            // OEE per Machine Chart
            updateOEEPerMachineChart(filteredRecords);
            
            // A vs P vs Q Chart
            updateAPQChart(filteredRecords);
            
            // ODT Chart
            updateODTChart(filteredRecords);
            
            // Line Stop Charts
            updateLineStopCharts(filteredRecords);
            
            // Minor Stop Chart
            updateMinorStopChart(filteredRecords);
        }

        function updateOEETrendChart(records) {
            const ctx = document.getElementById('oee-trend-chart').getContext('2d');
            
            if (charts.oeeTrend) {
                charts.oeeTrend.destroy();
            }
            
            // Create color array based on OEE values
            const colors = records.map(r => r.oee <= 88 ? '#ef4444' : '#8b5cf6');
            const pointBackgroundColors = records.map(r => r.oee <= 88 ? '#ef4444' : '#8b5cf6');
            
            charts.oeeTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: records.map(r => `${r.date} ${r.shift}`),
                    datasets: [{
                        label: 'OEE %',
                        data: records.map(r => r.oee),
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        pointBackgroundColor: pointBackgroundColors,
                        pointBorderColor: pointBackgroundColors,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        tension: 0.4,
                        fill: true,
                        segment: {
                            borderColor: ctx => {
                                const dataIndex = ctx.p0DataIndex;
                                return records[dataIndex] && records[dataIndex].oee <= 88 ? '#ef4444' : '#8b5cf6';
                            }
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `OEE: ${context.parsed.y.toFixed(1)}% ${context.parsed.y <= 88 ? '(Below Target)' : ''}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateAPQChart(records) {
            const ctx = document.getElementById('apq-chart').getContext('2d');
            
            if (charts.apq) {
                charts.apq.destroy();
            }
            
            const avgA = records.length > 0 ? records.reduce((sum, r) => sum + r.availability, 0) / records.length : 0;
            const avgP = records.length > 0 ? records.reduce((sum, r) => sum + r.performance, 0) / records.length : 0;
            const avgQ = records.length > 0 ? records.reduce((sum, r) => sum + r.quality, 0) / records.length : 0;
            
            // Determine colors based on thresholds
            const colorA = avgA < 93 ? 'rgba(239, 68, 68, 0.8)' : 'rgba(16, 185, 129, 0.8)';
            const colorP = avgP < 98 ? 'rgba(239, 68, 68, 0.8)' : 'rgba(16, 185, 129, 0.8)';
            const colorQ = avgQ < 99 ? 'rgba(239, 68, 68, 0.8)' : 'rgba(139, 92, 246, 0.8)';
            
            charts.apq = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Availability', 'Performance', 'Quality'],
                    datasets: [{
                        label: 'Average %',
                        data: [avgA, avgP, avgQ],
                        backgroundColor: [colorA, colorP, colorQ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const thresholds = { 'Availability': 93, 'Performance': 98, 'Quality': 99 };
                                    const threshold = thresholds[context.label];
                                    const value = context.parsed.y;
                                    const status = value < threshold ? `(Below ${threshold}%)` : `(Above ${threshold}%)`;
                                    return `${context.label}: ${value.toFixed(1)}% ${status}`;
                                }
                            }
                        }
                    }
                },
                plugins: [{
                    id: 'apqLabels',
                    afterDatasetsDraw: function(chart) {
                        const ctx = chart.ctx;
                        chart.data.datasets.forEach((dataset, i) => {
                            const meta = chart.getDatasetMeta(i);
                            meta.data.forEach((bar, index) => {
                                const dataValue = dataset.data[index];
                                const text = `${dataValue.toFixed(1)}%`;
                                
                                ctx.save();
                                ctx.font = 'bold 14px Arial';
                                ctx.fillStyle = '#ffffff';
                                ctx.textAlign = 'center';
                                ctx.textBaseline = 'middle';
                                // Position inside bar, near the top
                                ctx.fillText(text, bar.x, bar.y + 15);
                                ctx.restore();
                            });
                        });
                    }
                }]
            });
        }

        function updateLineStopCharts(records) {
            // Line Stop Mesin Chart
            const lineStopMesinData = {};
            records.forEach(record => {
                const durations = JSON.parse(record.line_stop_durations || '{}');
                if (durations.mesin) {
                    Object.entries(durations.mesin).forEach(([key, value]) => {
                        if (value > 0) {
                            lineStopMesinData[key] = (lineStopMesinData[key] || 0) + value;
                        }
                    });
                }
            });
            
            const topLineStopMesin = Object.entries(lineStopMesinData)
                .filter(([, value]) => value > 0)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);
            
            updateHorizontalBarChartSmart('line-stop-mesin-chart', 'lineStopMesin', 
                'Line Stop Mesin (Minutes)', topLineStopMesin, 'rgba(239, 68, 68, 0.8)');
            
            // Line Stop Non Mesin Chart
            const lineStopNonMesinData = {};
            records.forEach(record => {
                const durations = JSON.parse(record.line_stop_durations || '{}');
                if (durations.nonMesin) {
                    Object.entries(durations.nonMesin).forEach(([key, value]) => {
                        if (value > 0) {
                            lineStopNonMesinData[key] = (lineStopNonMesinData[key] || 0) + value;
                        }
                    });
                }
            });
            
            const topLineStopNonMesin = Object.entries(lineStopNonMesinData)
                .filter(([, value]) => value > 0)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);
            
            updateHorizontalBarChartSmart('line-stop-non-mesin-chart', 'lineStopNonMesin', 
                'Line Stop Non Mesin (Minutes)', topLineStopNonMesin, 'rgba(251, 191, 36, 0.8)');
        }

        function updateODTChart(records) {
            const odtData = {};
            records.forEach(record => {
                const odtTimes = JSON.parse(record.odt_actual_times || '{}');
                Object.entries(odtTimes).forEach(([key, value]) => {
                    if (value > 0) {
                        odtData[key] = (odtData[key] || 0) + value;
                    }
                });
            });
            
            const topODT = Object.entries(odtData)
                .filter(([, value]) => value > 0)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);
            
            updateHorizontalBarChartSmart('odt-chart', 'odt', 
                'ODT Time (Minutes)', topODT, 'rgba(139, 92, 246, 0.8)');
        }

        function updateMinorStopChart(records) {
            const minorStopData = {};
            records.forEach(record => {
                const minorStops = JSON.parse(record.minor_stop_frequencies || '{}');
                Object.entries(minorStops).forEach(([key, value]) => {
                    if (value > 0) {
                        minorStopData[key] = (minorStopData[key] || 0) + value;
                    }
                });
            });
            
            const topMinorStop = Object.entries(minorStopData)
                .filter(([, value]) => value > 0)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);
            
            updateHorizontalBarChartSmart('minor-stop-chart', 'minorStop', 
                'Minor Stop Frequency (Count)', topMinorStop, 'rgba(249, 115, 22, 0.8)');
        }

        function updateOEEPerMachineChart(records) {
            const machineOEE = {};
            records.forEach(record => {
                if (!machineOEE[record.machine]) {
                    machineOEE[record.machine] = { total: 0, count: 0 };
                }
                machineOEE[record.machine].total += record.oee;
                machineOEE[record.machine].count += 1;
            });
            
            const avgOEEPerMachine = Object.entries(machineOEE).map(([machine, data]) => [
                machine, data.total / data.count
            ]);
            
            const ctx = document.getElementById('oee-per-machine-chart').getContext('2d');
            
            if (charts.oeePerMachine) {
                charts.oeePerMachine.destroy();
            }
            
            // Create color array based on OEE values
            const colors = avgOEEPerMachine.map(([, oee]) => 
                oee <= 88 ? 'rgba(239, 68, 68, 0.8)' : 'rgba(102, 126, 234, 0.8)'
            );
            
            charts.oeePerMachine = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: avgOEEPerMachine.map(([machine]) => machine),
                    datasets: [{
                        label: 'Average OEE %',
                        data: avgOEEPerMachine.map(([, oee]) => oee),
                        backgroundColor: colors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `OEE: ${context.parsed.y.toFixed(1)}% ${context.parsed.y <= 88 ? '(Below Target)' : ''}`;
                                }
                            }
                        }
                    }
                },
                plugins: [{
                    id: 'oeeTargetLine',
                    afterDatasetsDraw: function(chart) {
                        const ctx = chart.ctx;
                        const chartArea = chart.chartArea;
                        const yScale = chart.scales.y;
                        
                        // Draw target line at 88%
                        const yPosition = yScale.getPixelForValue(88);
                        
                        ctx.save();
                        ctx.strokeStyle = 'rgba(255, 99, 132, 0.8)';
                        ctx.lineWidth = 3;
                        ctx.setLineDash([10, 5]);
                        ctx.beginPath();
                        ctx.moveTo(chartArea.left, yPosition);
                        ctx.lineTo(chartArea.right, yPosition);
                        ctx.stroke();
                        ctx.setLineDash([]);
                        
                        // Draw label
                        ctx.fillStyle = 'rgba(255, 99, 132, 0.9)';
                        ctx.fillRect(chartArea.right - 95, yPosition - 12, 90, 24);
                        ctx.font = 'bold 12px Arial';
                        ctx.fillStyle = '#ffffff';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText('Target 88%', chartArea.right - 50, yPosition);
                        
                        ctx.restore();
                        
                        // Draw value labels INSIDE bars
                        chart.data.datasets.forEach((dataset, i) => {
                            const meta = chart.getDatasetMeta(i);
                            meta.data.forEach((bar, index) => {
                                const dataValue = dataset.data[index];
                                const text = `${dataValue.toFixed(1)}%`;
                                
                                ctx.save();
                                ctx.font = 'bold 14px Arial';
                                ctx.fillStyle = '#ffffff';
                                ctx.textAlign = 'center';
                                ctx.textBaseline = 'middle';
                                // Position inside bar, near the top
                                ctx.fillText(text, bar.x, bar.y + 15);
                                ctx.restore();
                            });
                        });
                    }
                }]
            });
        }

        function updateHorizontalBarChartSmart(canvasId, chartKey, label, data, color) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            if (charts[chartKey]) {
                charts[chartKey].destroy();
            }
            
            // Calculate max value for dynamic positioning
            const maxValue = Math.max(...data.map(([, value]) => value));
            const threshold = maxValue * 0.25; // 25% of max value
            
            charts[chartKey] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(([name]) => name),
                    datasets: [{
                        label: label,
                        data: data.map(([, value]) => value),
                        backgroundColor: color || 'rgba(239, 68, 68, 0.8)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.x} ${label.includes('Count') ? 'times' : 'minutes'}`;
                                }
                            }
                        }
                    }
                },
                plugins: [{
                    id: 'smartLabels',
                    afterDatasetsDraw: function(chart) {
                        const ctx = chart.ctx;
                        chart.data.datasets.forEach((dataset, i) => {
                            const meta = chart.getDatasetMeta(i);
                            meta.data.forEach((bar, index) => {
                                const dataValue = dataset.data[index];
                                const unit = label.includes('Count') ? '' : ' min';
                                const text = `${dataValue}${unit}`;
                                
                                ctx.save();
                                ctx.font = 'bold 12px Arial';
                                ctx.textBaseline = 'middle';
                                
                                // Posisi label berdasarkan ukuran bar
                                if (dataValue < threshold) {
                                    // Bar kecil: label di luar (kanan bar)
                                    ctx.fillStyle = color || 'rgba(239, 68, 68, 0.8)';
                                    ctx.textAlign = 'left';
                                    ctx.fillText(text, bar.x + 5, bar.y);
                                } else {
                                    // Bar besar: label di dalam (10px dari kanan bar)
                                    ctx.fillStyle = '#ffffff';
                                    ctx.textAlign = 'right';
                                    ctx.fillText(text, bar.x - 10, bar.y);
                                }
                                
                                ctx.restore();
                            });
                        });
                    }
                }]
            });
        }

        // Helper function to get shift minutes
        function getShiftMinutes(shift) {
            const shiftMap = {
                'SHIFT1': 510,
                'SHIFT2': 450,
                'SHIFT3': 510,
                'LONGSHIFT_PAGI': 720,
                'LONGSHIFT_MALAM': 720
            };
            return shiftMap[shift.toUpperCase()] || 480;
        }

        // Helper function to get shift order
        function getShiftOrder(shift) {
            const shiftOrder = {
                'SHIFT1': 1,
                'SHIFT2': 2,
                'SHIFT3': 3,
                'LONGSHIFT_PAGI': 4,
                'LONGSHIFT_MALAM': 5
            };
            return shiftOrder[shift.toUpperCase()] || 99;
        }

        function updateOperatorPerformance() {
            const filteredRecords = getFilteredRecords('dashboard');
            const operatorData = {};
            
            filteredRecords.forEach(record => {
                if (!operatorData[record.pic]) {
                    operatorData[record.pic] = { 
                        records: 0, 
                        totalOEE: 0, 
                        totalOutput: 0,
                        totalTarget: 0
                    };
                }
                
                // Calculate target output for this record
                const machine = machines.find(m => m.name === record.machine);
                if (machine) {
                    // Get shift duration
                    const shiftMinutes = getShiftMinutes(record.shift);
                    
                    // Calculate total ODT
                    const odtTimes = JSON.parse(record.odt_actual_times || '{}');
                    const totalODT = Object.values(odtTimes).reduce((sum, time) => sum + (time || 0), 0);
                    
                    // Calculate total Line Stop
                    const lineStopDurations = JSON.parse(record.line_stop_durations || '{}');
                    const totalLineStopMesin = Object.values(lineStopDurations.mesin || {}).reduce((sum, time) => sum + (time || 0), 0);
                    const totalLineStopNonMesin = Object.values(lineStopDurations.nonMesin || {}).reduce((sum, time) => sum + (time || 0), 0);
                    
                    // Calculate target
                    const availableTime = shiftMinutes - totalODT - totalLineStopMesin - totalLineStopNonMesin;
                    const targetOutput = Math.max(0, availableTime * machine.target_per_minute);
                    
                    operatorData[record.pic].totalTarget += targetOutput;
                }
                
                operatorData[record.pic].records += 1;
                operatorData[record.pic].totalOEE += record.oee;
                operatorData[record.pic].totalOutput += record.actual_output;
            });
            
            const tbody = document.getElementById('operator-performance-table');
            tbody.innerHTML = '';
            
            // Sort by achievement (highest first)
            const sortedOperators = Object.entries(operatorData).sort((a, b) => {
                const achievementA = a[1].totalTarget > 0 ? (a[1].totalOutput / a[1].totalTarget) * 100 : 0;
                const achievementB = b[1].totalTarget > 0 ? (b[1].totalOutput / b[1].totalTarget) * 100 : 0;
                return achievementB - achievementA;
            });
            
            sortedOperators.forEach(([pic, data]) => {
                const avgOEE = data.totalOEE / data.records;
                const achievement = data.totalTarget > 0 ? (data.totalOutput / data.totalTarget) * 100 : 0;
                // Cap achievement at 100%
                const cappedAchievement = Math.min(achievement, 100);
                
                const row = document.createElement('tr');
                row.className = 'border-b';
                row.innerHTML = `
                    <td class="px-2 md:px-4 py-3">${pic}</td>
                    <td class="px-2 md:px-4 py-3">${avgOEE.toFixed(1)}%</td>
                    <td class="px-2 md:px-4 py-3">${Math.round(data.totalTarget).toLocaleString()}</td>
                    <td class="px-2 md:px-4 py-3">${data.totalOutput.toLocaleString()}</td>
                    <td class="px-2 md:px-4 py-3 font-bold ${cappedAchievement >= 100 ? 'text-green-600' : 'text-red-600'}">
                        ${cappedAchievement.toFixed(1)}%
                    </td>
                    <td class="px-2 md:px-4 py-3">${data.records}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateDashboardHistoryTable() {
            const filteredRecords = getFilteredRecords('dashboard');
            const tbody = document.getElementById('dashboard-history-table');
            tbody.innerHTML = '';
            
            // Sort by date (ascending) then by shift order (ascending)
            const sortedRecords = [...filteredRecords].sort((a, b) => {
                const dateCompare = a.date.localeCompare(b.date);
                if (dateCompare !== 0) return dateCompare;
                return getShiftOrder(a.shift) - getShiftOrder(b.shift);
            });
            
            sortedRecords.forEach(record => {
                const row = document.createElement('tr');
                row.className = `border-b ${record.oee < 88 ? 'pulse-red' : ''}`;
                
                // Parse complex data for display (all UPPERCASE)
                const odtTimes = JSON.parse(record.odt_actual_times || '{}');
                const lineStopDurations = JSON.parse(record.line_stop_durations || '{}');
                const minorStopFreqs = JSON.parse(record.minor_stop_frequencies || '{}');
                const wrNumbers = JSON.parse(record.wr_number || '{}');
                
                // Filter out items with zero or empty values
                const odtDisplay = Object.entries(odtTimes)
                    .filter(([k,v]) => v > 0)
                    .map(([k,v]) => `${k.toUpperCase()}:${v}MIN`)
                    .join(', ') || '-';
                    
                const lineStopDisplay = [
                    ...Object.entries(lineStopDurations.mesin || {})
                        .filter(([k,v]) => v > 0)
                        .map(([k,v]) => `M-${k.toUpperCase()}:${v}MIN`),
                    ...Object.entries(lineStopDurations.nonMesin || {})
                        .filter(([k,v]) => v > 0)
                        .map(([k,v]) => `NM-${k.toUpperCase()}:${v}MIN`)
                ].join(', ') || '-';
                
                const minorStopDisplay = Object.entries(minorStopFreqs)
                    .filter(([k,v]) => v > 0)
                    .map(([k,v]) => `${k.toUpperCase()}:${v}X`)
                    .join(', ') || '-';
                
                const wrDisplay = Object.entries(wrNumbers)
                    .map(([k,v]) => `${k.toUpperCase()}:${v.toUpperCase()}`)
                    .join(', ') || '-';
                
                row.innerHTML = `
                    <td class="px-2 py-2 text-xs">${record.date}</td>
                    <td class="px-2 py-2 text-xs">${record.shift.toUpperCase()}</td>
                    <td class="px-2 py-2 text-xs">${record.machine.toUpperCase()}</td>
                    <td class="px-2 py-2 text-xs">${record.pic.toUpperCase()}</td>
                    <td class="px-2 py-2 text-xs">${record.product.toUpperCase()}</td>
                    <td class="px-2 py-2 text-xs">${record.batch.toUpperCase()}</td>
                    <td class="px-2 py-2 text-xs">${record.actual_output}</td>
                    <td class="px-2 py-2 text-xs">${record.reject}</td>
                    <td class="px-2 py-2 text-xs">${record.availability.toFixed(1)}%</td>
                    <td class="px-2 py-2 text-xs">${record.performance.toFixed(1)}%</td>
                    <td class="px-2 py-2 text-xs">${record.quality.toFixed(1)}%</td>
                    <td class="px-2 py-2 text-xs font-bold ${record.oee < 88 ? 'text-red-600' : 'text-green-600'}">${record.oee.toFixed(1)}%</td>
                    <td class="px-2 py-2 text-xs" title="${wrDisplay}">${wrDisplay.length > 20 ? wrDisplay.substring(0, 20) + '...' : wrDisplay}</td>
                    <td class="px-2 py-2 text-xs" title="${odtDisplay}">${odtDisplay.length > 20 ? odtDisplay.substring(0, 20) + '...' : odtDisplay}</td>
                    <td class="px-2 py-2 text-xs" title="${lineStopDisplay}">${lineStopDisplay.length > 20 ? lineStopDisplay.substring(0, 20) + '...' : lineStopDisplay}</td>
                    <td class="px-2 py-2 text-xs" title="${minorStopDisplay}">${minorStopDisplay.length > 20 ? minorStopDisplay.substring(0, 20) + '...' : minorStopDisplay}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function applyDashboardFilters() {
            updateDashboard();
        }

        // Export Functions
        function previewExport() {
            const filteredRecords = getFilteredRecords('export');
            const preview = document.getElementById('export-preview');
            const info = document.getElementById('preview-info');
            const header = document.getElementById('preview-header');
            const body = document.getElementById('preview-body');
            
            info.textContent = `ğŸ“Š ${filteredRecords.length} records will be exported`;
            
            // Create header
            header.innerHTML = `
                <th class="px-2 py-2 text-left text-xs">Date</th>
                <th class="px-2 py-2 text-left text-xs">Shift</th>
                <th class="px-2 py-2 text-left text-xs">Machine</th>
                <th class="px-2 py-2 text-left text-xs">PIC</th>
                <th class="px-2 py-2 text-left text-xs">Product</th>
                <th class="px-2 py-2 text-left text-xs">OEE%</th>
            `;
            
            // Create body (first 10 records)
            body.innerHTML = '';
            filteredRecords.slice(0, 10).forEach(record => {
                const row = document.createElement('tr');
                row.className = 'border-b';
                row.innerHTML = `
                    <td class="px-2 py-2 text-xs">${record.date}</td>
                    <td class="px-2 py-2 text-xs">${record.shift.toUpperCase()}</td>
                    <td class="px-2 py-2 text-xs">${record.machine.toUpperCase()}</td>
                    <td class="px-2 py-2 text-xs">${record.pic.toUpperCase()}</td>
                    <td class="px-2 py-2 text-xs">${record.product.toUpperCase()}</td>
                    <td class="px-2 py-2 text-xs">${record.oee.toFixed(1)}%</td>
                `;
                body.appendChild(row);
            });
            
            if (filteredRecords.length > 10) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="6" class="px-2 py-2 text-xs text-gray-500 text-center">... and ${filteredRecords.length - 10} more records</td>`;
                body.appendChild(row);
            }
            
            preview.classList.remove('hidden');
        }

        function exportData() {
            const exportBtn = document.getElementById('export-btn');
            exportBtn.classList.add('loading');
            exportBtn.textContent = 'Exporting...';
            
            try {
                const filteredRecords = getFilteredRecords('export');
                const format = document.getElementById('export-format').value;
                
                if (format === 'csv') {
                    exportToCSV(filteredRecords);
                } else {
                    exportToExcel(filteredRecords);
                }
                
                showToast('Data exported successfully', 'success');
            } catch (error) {
                showToast('Error exporting data: ' + error.message, 'error');
            } finally {
                exportBtn.classList.remove('loading');
                exportBtn.textContent = 'ğŸ“¥ Export Data';
            }
        }

        function exportToCSV(records) {
            const headers = [
                'Date', 'Shift', 'Machine', 'PIC', 'Product', 'Batch',
                'Actual Output', 'Reject', 'Availability %', 'Performance %',
                'Quality %', 'OEE %', 'WR Number', 'ODT Times', 'Line Stop', 'Minor Stop'
            ];
            
            const csvContent = [
                headers.join(','),
                ...records.map(record => [
                    record.date,
                    record.shift.toUpperCase(),
                    record.machine.toUpperCase(),
                    record.pic.toUpperCase(),
                    record.product.toUpperCase(),
                    record.batch.toUpperCase(),
                    record.actual_output,
                    record.reject,
                    record.availability.toFixed(1),
                    record.performance.toFixed(1),
                    record.quality.toFixed(1),
                    record.oee.toFixed(1),
                    record.wr_number || '',
                    `"${JSON.stringify(JSON.parse(record.odt_actual_times || '{}'))}"`,
                    `"${JSON.stringify(JSON.parse(record.line_stop_durations || '{}'))}"`,
                    `"${JSON.stringify(JSON.parse(record.minor_stop_frequencies || '{}'))}"`
                ].join(','))
            ].join('\n');
            
            downloadFile(csvContent, `OEE_Export_${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
        }

        function exportToExcel(records) {
            // Simple Excel export using HTML table format
            const headers = [
                'Date', 'Shift', 'Machine', 'PIC', 'Product', 'Batch',
                'Actual Output', 'Reject', 'Availability %', 'Performance %',
                'Quality %', 'OEE %', 'WR Number'
            ];
            
            let excelContent = `
                <table>
                    <tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>
                    ${records.map(record => `
                        <tr style="${record.oee < 88 ? 'background-color: #fecaca;' : ''}">
                            <td>${record.date}</td>
                            <td>${record.shift.toUpperCase()}</td>
                            <td>${record.machine.toUpperCase()}</td>
                            <td>${record.pic.toUpperCase()}</td>
                            <td>${record.product.toUpperCase()}</td>
                            <td>${record.batch.toUpperCase()}</td>
                            <td>${record.actual_output}</td>
                            <td>${record.reject}</td>
                            <td>${record.availability.toFixed(1)}</td>
                            <td>${record.performance.toFixed(1)}</td>
                            <td>${record.quality.toFixed(1)}</td>
                            <td>${record.oee.toFixed(1)}</td>
                            <td>${record.wr_number || ''}</td>
                        </tr>
                    `).join('')}
                </table>
            `;
            
            downloadFile(excelContent, `OEE_Export_${new Date().toISOString().split('T')[0]}.xls`, 'application/vnd.ms-excel');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Utility Functions
        function getFilteredRecords(section) {
            let startDate, endDate, machine, operator;
            
            if (section === 'dashboard') {
                startDate = document.getElementById('filter-start-date').value;
                endDate = document.getElementById('filter-end-date').value;
                machine = document.getElementById('filter-machine').value;
                operator = document.getElementById('filter-operator').value;
            } else if (section === 'export') {
                startDate = document.getElementById('export-start-date').value;
                endDate = document.getElementById('export-end-date').value;
                machine = document.getElementById('export-machine').value;
            }
            
            return oeeRecords.filter(record => {
                if (startDate && record.date < startDate) return false;
                if (endDate && record.date > endDate) return false;
                if (machine && record.machine !== machine) return false;
                if (operator && record.pic !== operator) return false;
                return true;
            });
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast fixed top-4 right-4 px-6 py-4 rounded-xl text-white z-50 shadow-2xl ${
                type === 'success' ? 'bg-gradient-to-r from-green-500 to-green-600' : 
                type === 'error' ? 'bg-gradient-to-r from-red-500 to-red-600' : 
                'bg-gradient-to-r from-blue-500 to-blue-600'
            }`;
            toast.innerHTML = `<strong>${message}</strong>`;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Initialize application when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b04bf1c167ca439',t:'MTc2NjEyNDcyOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
